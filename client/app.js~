Meteor.startup(function()
	       {
                    window.addEventListener("loginwithpassword", function(e) {
                       var username = e.detail.username;
                       var password = e.detail.password;
                       Meteor.loginWithPassword(username, password, function(error) {
                           e.detail.callback(error);
		       });
		   });                   
                
                   window.addEventListener("logout", function(e) {
                       Meteor.logout(function(error){
                           e.detail.callback(error);
		       });
		   });

                   window.addEventListener("createuser", function(e) {
                       var user;
                       user = {
                           email: e.detail.username,
                           password: e.detail.password
                       };
                       Accounts.createUser(user, function(error){
                           e.detail.callback(error);
                       });
		   });                            
                            
                   window.addEventListener("elemconfig", function(e) {
                       if (Meteor.userId()){
                       if (ElemRep.find({_id: e.detail._id}).fetch().length == 0) {
                           var owner = Meteor.userId();
                           e.detail.owner = owner;
                           e.detail._id = e.detail._id+"$"+owner;
                       ElemRep.insert(e.detail);
			   }
		       }
		   });
		   window.addEventListener("changeinfo", function(e){
                       if (Meteor.userId()){
                       var obj={};
                       var property = Object.keys(e.detail)[0];
                       obj[property] = e.detail[property];
                       obj['changed_at'] = new Date().getTime();
		       ElemRep.update(
			   {_id: e.srcElement.app + "$" + e.srcElement.id + "$" + Meteor.userId()}, 
			   {$set: obj})
		       }
		   });
                   window.addEventListener("loadapp", function(e){
                       var url;
                       var appName;
                       if ((!e.detail.forcedbyurl) && (e.detail.url || e.detail.app)){
			   if (e.detail.url) {
                        url = new URL(e.detail.url);
			       appName = url.pathname.split('/').pop().split('.').reverse().pop();
                      }
                           else {
                               appName = e.detail.app;
			   }

		       if (!(sessionStorage.getItem(appName + "$" + appName))) {
                       var loader = document.querySelector('vip-loader');
                       Meteor.subscribe('appPub', appName, function() {
                           var appElemRepsCursor = ElemRep.find({owner: Meteor.userId(), app: appName});
                           appElemRepsCursor.observeChanges({
                               changed: function (id, fields) {
                                   if (Object.keys(fields).length < 2) {
                                   var elemName = id.split('$').pop();
                                   var elem = document.querySelector('#' + elemName);
                                   if (elem) {
                                       for (var field in fields) {
					   elem[field] = fields[field];
				       }
				   }
				   }
			       }
			   });

                           var appConfig = {};
                    	   //if (ElemRep.find({app: appName}).fetch().length == 0) {
                           if(appElemRepsCursor.fetch().length == 0){
                               url.protocol = "meteor:";
                               loader.url = url.toString();
			   }
			   else{
                           appElemRepsCursor.fetch().forEach(function(elem){appConfig[elem.id]=elem;});
			       loader.loadConfig(appConfig);
			   }		       
		       });
		       }
		       }
		   });
		   Router.route('/', function(){
                       this.render('Home');
		   });
	       });